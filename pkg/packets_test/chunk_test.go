package packets_test

import (
	"fmt"

	"github.com/go-mclib/data/pkg/data/blocks"
	"github.com/go-mclib/data/pkg/data/chunks"
	"github.com/go-mclib/data/pkg/data/registries"
	"github.com/go-mclib/data/pkg/packets"
	ns "github.com/go-mclib/protocol/java_protocol/net_structures"
	"github.com/go-mclib/protocol/nbt"
)

// captured chunk hex data (chunk at 1,1 with hay bales and a sign)
const chunkHex = "" +
	"000000010000000103052501008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100805028180a0401008040201008040140c06028100804010080402010080501c0a050201008040100804020140c07014080402010080401008060301c0c0601008040201008040140c06030180a0401008040201008040140a05020100804010080402010080501008040201008040000000020100a05042501008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100805028180a0401008040201008040140c06028100804010080402010080501c0a050201008040100804020140c07014080402010080401008060301c0c0601008040201008040140c06030180a0401008040201008040140a05020100804010080402010080501008040201008040000000020100a05012501008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100804020100804010080402010080401008040201008040100805028180a0401008040201008040140c06028100804010080402010080501c0a050201008040100804020140c07014080402010080401008060301c0c0601008040201008040140c06030180a0401008040201008040140a05020100804010080402010080501008040201008040000000020100a05981104330406550a09009463b72c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111112222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222111122222222222112112222222222211111122222222221112112222222222111111222222222221111222222222222211222222222222333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333344443333333333344444333333333334444443333333333444444333333333344444433333333333444433333333333334433333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333343333333333333344333333333333344433333333333344444333333333333444433333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333453333333333333343333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002800000000002801cbffc6070a0a00096261636b5f746578740100106861735f676c6f77696e675f7465787400080005636f6c6f720005626c61636b0900086d65737361676573080000000400000000000000000001000869735f7761786564000a000a66726f6e745f746578740100106861735f676c6f77696e675f7465787400080005636f6c6f720005626c61636b0900086d65737361676573080000000400066e6565646c650002696e0001610008686179737461636b0000010000000000000006000100000000000000010100000000000000070280100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000" +
	"ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0f00f0ffffffffff0f0000ffffffffff000000ffffffffff000000ffffffffff000000ffffffffff0f00f0ffffffffffff00fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0ffffffffffffff00ffffffffffffff00f0ffffffffff0f0000ffffffffff0f00f0ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0fffffffffffffff0fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff" +
	"8010ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00"

func init() {
	// S2CSetChunkCacheCenter: set center chunk to (1, 1)
	capturedPackets[&packets.S2CSetChunkCacheCenter{
		ChunkX: 1,
		ChunkZ: 1,
	}] = hexToBytesMust("0101")

	// S2CChunkBatchStart: empty packet
	capturedPackets[&packets.S2CChunkBatchStart{}] = nil

	// S2CChunkBatchFinished: batch size = 9
	capturedPackets[&packets.S2CChunkBatchFinished{
		BatchSize: 9,
	}] = hexToBytesMust("09")

	// S2CLevelChunkWithLight: chunk at (1, 1) with 50 hay bales and a sign
	// not registered in capturedPackets because heightmaps use map[int32][]int64,
	// and Go map iteration order is non-deterministic, causing byte-level mismatches
	// in the round-trip comparison. instead, we validate decode + content separately.
	validateChunkPacket()
}

func validateChunkPacket() {
	chunkRaw := hexToBytesMust(chunkHex)
	var pkt packets.S2CLevelChunkWithLight
	if err := pkt.Read(ns.NewReader(chunkRaw)); err != nil {
		panic(fmt.Errorf("failed to decode chunk packet: %w", err))
	}

	// encode â†’ decode round-trip
	buf := ns.NewWriter()
	if err := pkt.Write(buf); err != nil {
		panic(fmt.Errorf("failed to encode chunk packet: %w", err))
	}
	var roundTripped packets.S2CLevelChunkWithLight
	if err := roundTripped.Read(ns.NewReader(buf.Bytes())); err != nil {
		panic(fmt.Errorf("failed to decode round-tripped chunk packet: %w", err))
	}

	validateChunkContents(&pkt)
	validateChunkContents(&roundTripped)
}

func validateChunkContents(pkt *packets.S2CLevelChunkWithLight) {
	if pkt.ChunkX != 1 || pkt.ChunkZ != 1 {
		panic(fmt.Errorf("chunk position: got (%d, %d), want (1, 1)", pkt.ChunkX, pkt.ChunkZ))
	}

	// parse chunk sections and count blocks
	col, err := chunks.ParseChunkColumn(int32(pkt.ChunkX), int32(pkt.ChunkZ), pkt.ChunkData, nil)
	if err != nil {
		panic(fmt.Errorf("failed to parse chunk column: %w", err))
	}

	hayBlockState := blocks.StateID(blocks.HayBlock, map[string]string{"axis": "y"})
	signBlockState := blocks.StateID(blocks.PaleOakWallSign, map[string]string{"facing": "west", "waterlogged": "false"})

	hayCount := 0
	signCount := 0
	for y := chunks.MinY; y < chunks.MaxY; y++ {
		for x := range 16 {
			for z := range 16 {
				state := col.GetBlockState(x, y, z)
				switch state {
				case hayBlockState:
					hayCount++
				case signBlockState:
					signCount++
				}
			}
		}
	}
	if hayCount != 50 {
		panic(fmt.Errorf("hay block count: got %d, want 50", hayCount))
	}
	if signCount != 1 {
		panic(fmt.Errorf("sign block count: got %d, want 1", signCount))
	}

	// validate sign block entity
	if len(pkt.ChunkData.BlockEntities) != 1 {
		panic(fmt.Errorf("block entity count: got %d, want 1", len(pkt.ChunkData.BlockEntities)))
	}
	be := pkt.ChunkData.BlockEntities[0]
	// has to be minecraft:sign even if it's pale_oak_wall_sign - they're generic in the registry
	signEntityType := ns.VarInt(registries.BlockEntityType.Get("minecraft:sign"))
	if be.Type != signEntityType {
		panic(fmt.Errorf("block entity type: got %d, want %d (sign)", be.Type, signEntityType))
	}

	// validate sign front text messages: "needle", "in", "a", "haystack"
	compound, ok := be.Data.(nbt.Compound)
	if !ok {
		panic(fmt.Errorf("block entity data is %T, want nbt.Compound", be.Data))
	}
	frontText, ok := compound["front_text"].(nbt.Compound)
	if !ok {
		panic("missing front_text compound in sign block entity")
	}
	messages, ok := frontText["messages"].(nbt.List)
	if !ok {
		panic("missing messages list in sign front_text")
	}
	expected := []string{"needle", "in", "a", "haystack"}
	if len(messages.Elements) != len(expected) {
		panic(fmt.Errorf("sign messages count: got %d, want %d", len(messages.Elements), len(expected)))
	}
	for i, want := range expected {
		got := string(messages.Elements[i].(nbt.String))
		if got != want {
			panic(fmt.Errorf("sign message %d: got %q, want %q", i, got, want))
		}
	}
}
